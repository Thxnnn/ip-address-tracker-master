<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- displays site properly based on user's device -->

    <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">

    <title>Frontend Mentor | IP Address Tracker</title>



    <!-- stlye -->

    <link rel="stylesheet" href="style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

    <!-- map -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
   
</head>

<body>

   <div class="container">
        <div class="header-wrapper">
            <div class="header-item">
                <h2>IP Address Tracker</h2>
                <div class="search-input">
                    <input type="text" name="search" id="search" placeholder="Search for any IP address or domain" value="192.212.174.101">
                    <button id="searchBtn">
                        <img src="images/icon-arrow.svg" alt="">
                    </button>
                </div>
            
            </div>
            <div class="infomap">
                <div>
                    <p>IP Address</p>
                    <span id="IPaddress"></span>
                </div>
                <div>
                    <p>Location</p>
                    <span id="location"></span>
                </div>
                <div>
                    <p>Timezone</p>
                    <span id="timezone"></span>
                </div>
                <div>
                    <p>ISP</p>
                    <span id="isp"></span>
                </div>
            </div>
            
            
        </div>

        

        <div class="">
            <div id="map">

            </div>
        </div>
   </div>

    
    <div class="attribution">
        Challenge by <a href="https://www.frontendmentor.io?ref=challenge" target="_blank">Frontend Mentor</a>. 
        Coded by <a href="https://github.com/Thxnnn/stats-preview-card-component.git">Thxnnn</a>.
    </div>
</body>

</html>


<script>
    const IPaddressText = document.getElementById("IPaddress")
    const locationText = document.getElementById("location")
    const timezoneText = document.getElementById("timezone")
    const ispText = document.getElementById("isp")



    let map = L.map('map').setView([51.505, -0.09], 13);
    let marker

    const customIcon = L.icon({
        iconUrl: 'images/icon-location.svg',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    

    function FetchIP(ip) {
        fetch(`https://ipwhois.app/json/${ip}`)
            .then(res => res.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    const lat = data.latitude;
                    const lon = data.longitude;

                    const timeZone = data.timezone;
                    const now = new Date();

                    IPaddressText.innerHTML = data.ip;
                    locationText.innerHTML = data.city +", "+data.country+" "+data.zip;
                    timezoneText.innerHTML = getUTCOffsetString(now, timeZone)
                    ispText.innerHTML = data.isp
                
                    // ขยับ map ไปที่พิกัด
                    map.setView([lat, lon], 10);

                    // ลบ marker เก่าถ้ามี
                    if (marker) {
                        map.removeLayer(marker);
                    }

                    // เพิ่ม marker ใหม่
                    marker = L.marker([lat, lon], { icon: customIcon }).addTo(map)
                } else {
                    alert("ไม่พบตำแหน่งสำหรับ IP นี้");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error fetching IP location");
            });
    }



    // load map
    FetchIP(document.getElementById("search").value.trim())
    
        

    function getUTCOffsetString(date, timeZone) {
        // แปลง date ให้เป็นของ timezone ที่ต้องการ
        const options = { timeZone, hour12: false };
        const parts = new Intl.DateTimeFormat("en-US", options).formatToParts(date);

        // เอา offset ของ local date เทียบกับ UTC
        const localDate = new Date(date.toLocaleString("en-US", options));
        const diff = (localDate.getTime() - date.getTime()) / 60000; // นาที

        const sign = diff <= 0 ? "+" : "-";
        const pad = (n) => String(Math.floor(Math.abs(n))).padStart(2, "0");

        return `UTC${sign}${pad(diff / 60)}:${pad(diff % 60)}`;
    }


    


    document.getElementById("searchBtn").addEventListener("click", function() {

        const searchInput = document.getElementById("search").value.trim();

        function isIPv4(input) {
            const ipv4Regex = /^(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}$/;
            return ipv4Regex.test(input);
        }

        function isIPv6(input) {
            const ipv6Regex = /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;
            return ipv6Regex.test(input);
        }

        function isDomain(input) {
            return !isIPv4(input) && !isIPv6(input);
        }
        
        
                
        if (isDomain(searchInput)) {
            const domain = searchInput;
            fetch(`https://dns.google/resolve?name=${searchInput}`)
            .then(res => res.json())
            .then(data => {
                // เอา IP จาก answer record (type A)
                const answer = data.Answer.find(a => a.type === 1); // type 1 = A record
                const domainIP = answer.data
                FetchIP(domainIP)
            });

        }
        else if ( isIPv6(searchInput) || isIPv4(searchInput) ) {
            // เรียก GeoIP API
            FetchIP(searchInput)
        }

        

        
    });


    
</script>